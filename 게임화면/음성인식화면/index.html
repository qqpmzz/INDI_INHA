<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost Spells - ìŒì„±ì¸ì‹</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <script>
        // iframe ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸í•˜ê³ , ì•„ë‹ˆë©´ ê¸°ë³¸ê²Œì„í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        if (window.parent === window) {
            window.location.href = '../ê¸°ë³¸ê²Œì„í™”ë©´/index.html';
        }
    </script>
    <div class="voice-container">
        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <button class="back-btn" onclick="goBack()">
            <span class="back-icon">â†</span>
            <span class="back-text">ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
        </button>

        <!-- 1ë‹¨ê³„: ìŒì„± ì¸ì‹ -->
        <div class="voice-stage active" id="listeningStage">
            <div class="voice-icon">ğŸ¤</div>
            <div class="voice-title">ìŒì„± ì¸ì‹ ì¤‘...</div>
            <div class="voice-subtitle">ìŠ¤í‚¬ ì´ë¦„ì„ ë§í•´ì£¼ì„¸ìš”</div>
            <div class="voice-visual">
                <div class="sound-wave"></div>
                <div class="sound-wave"></div>
                <div class="sound-wave"></div>
                <div class="sound-wave"></div>
            </div>
            <div class="voice-instructions">
                <p>2ì´ˆ í›„ ìë™ìœ¼ë¡œ ì¸ì‹ì„ ì‹œì‘í•©ë‹ˆë‹¤</p>
            </div>
        </div>

        <!-- 2ë‹¨ê³„: ê²°ê³¼ ë° ì •í™•ë„ -->
        <div class="voice-stage" id="resultStage">
            <div class="voice-icon">âœ¨</div>
            <div class="voice-title">ì¸ì‹ ê²°ê³¼</div>
            <div class="skill-result">
                <div class="skill-name-result" id="skillNameResult">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ê¸€ìë“¤ -->
                </div>
                <div class="accuracy-result">
                    ì •í™•ë„: <span id="accuracyPercent">0%</span>
                </div>
            </div>
            <div class="voice-instructions">
                <p>4ì´ˆ í›„ ìë™ìœ¼ë¡œ ê²Œì„ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤</p>
            </div>
        </div>

        <!-- ì§„í–‰ ë°” -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">ìŒì„± ì¸ì‹ ì¤€ë¹„ ì¤‘...</div>
        </div>
    </div>

    <script>
        let currentStage = 1;
        let isProcessing = false;

        // ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤í‚¬ ëª©ë¡ (ì˜ì–´ ì´ë¦„)
        const availableSkills = [
            { name: 'Fireball', korean: 'íŒŒì´ì–´ë³¼', pronunciation: 'íŒŒì´ì–´ë³¼' },
            { name: 'Ice Bolt', korean: 'ì•„ì´ìŠ¤ ë³¼íŠ¸', pronunciation: 'ì•„ì´ìŠ¤ ë³¼íŠ¸' },
            { name: 'Lightning', korean: 'ë¼ì´íŠ¸ë‹', pronunciation: 'ë¼ì´íŠ¸ë‹' },
            { name: 'Heal', korean: 'í', pronunciation: 'í' },
            { name: 'Shield', korean: 'ì‰´ë“œ', pronunciation: 'ì‰´ë“œ' },
            { name: 'Meteor', korean: 'ë©”í…Œì˜¤', pronunciation: 'ë©”í…Œì˜¤' },
            { name: 'Blizzard', korean: 'ë¸”ë¦¬ìë“œ', pronunciation: 'ë¸”ë¦¬ìë“œ' },
            { name: 'Earthquake', korean: 'ì–´ìŠ¤í€˜ì´í¬', pronunciation: 'ì–´ìŠ¤í€˜ì´í¬' },
            { name: 'Wind Blade', korean: 'ìœˆë“œ ë¸”ë ˆì´ë“œ', pronunciation: 'ìœˆë“œ ë¸”ë ˆì´ë“œ' },
            { name: 'Holy Light', korean: 'í™€ë¦¬ ë¼ì´íŠ¸', pronunciation: 'í™€ë¦¬ ë¼ì´íŠ¸' },
            { name: 'Dark Magic', korean: 'ë‹¤í¬ ë§¤ì§', pronunciation: 'ë‹¤í¬ ë§¤ì§' },
            { name: 'Teleport', korean: 'í…”ë ˆí¬íŠ¸', pronunciation: 'í…”ë ˆí¬íŠ¸' },
            { name: 'Time Stop', korean: 'íƒ€ì„ ìŠ¤í†±', pronunciation: 'íƒ€ì„ ìŠ¤í†±' },
            { name: 'Phoenix', korean: 'í”¼ë‹‰ìŠ¤', pronunciation: 'í”¼ë‹‰ìŠ¤' },
            { name: 'Dragon Breath', korean: 'ë“œë˜ê³¤ ë¸Œë ˆìŠ¤', pronunciation: 'ë“œë˜ê³¤ ë¸Œë ˆìŠ¤' }
        ];

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' || event.key.toLowerCase() === 'q') {
                goBack();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŒì„±ì¸ì‹ ì‹œì‘
        window.addEventListener('load', function () {
            startVoiceRecognition();
        });

        function startVoiceRecognition() {
            if (isProcessing) return;
            isProcessing = true;

            currentStage = 1;
            showStage(1);

            // 2ì´ˆ í›„ ì¸ì‹ ì‹œì‘
            setTimeout(() => {
                if (currentStage === 1) {
                    simulateVoiceRecognition();
                }
            }, 2000);
        }

        function simulateVoiceRecognition() {
            // ëœë¤í•œ ìŠ¤í‚¬ ì„ íƒ
            const randomSkill = availableSkills[Math.floor(Math.random() * availableSkills.length)];
            const accuracy = Math.floor(Math.random() * 40) + 60; // 60-100% ì •í™•ë„

            // ê²°ê³¼ ë‹¨ê³„ë¡œ ì „í™˜
            currentStage = 2;
            showStage(2);

            // ìŠ¤í‚¬ ì´ë¦„ ì• ë‹ˆë©”ì´ì…˜
            displaySkillNameWithAnimation(randomSkill.name);

            // ì •í™•ë„ í‘œì‹œ
            document.getElementById('accuracyPercent').textContent = accuracy + '%';

            // 4ì´ˆ í›„ ìë™ìœ¼ë¡œ ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            autoClose();
        }

        function displaySkillNameWithAnimation(skillName) {
            const container = document.getElementById('skillNameResult');
            container.innerHTML = '';

            const letters = skillName.split('');
            letters.forEach((letter, index) => {
                const span = document.createElement('span');
                span.className = 'skill-letter';
                span.textContent = letter === ' ' ? '\u00A0' : letter; // ê³µë°± ì²˜ë¦¬
                span.style.animationDelay = (index * 0.1) + 's';
                container.appendChild(span);
            });
        }

        function showStage(stageNumber) {
            // ëª¨ë“  ìŠ¤í…Œì´ì§€ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.voice-stage').forEach(stage => {
                stage.classList.remove('active');
            });

            // í•´ë‹¹ ìŠ¤í…Œì´ì§€ ë³´ì´ê¸°
            if (stageNumber === 1) {
                document.getElementById('listeningStage').classList.add('active');
                updateProgress(0, 'ìŒì„± ì¸ì‹ ì¤‘...');

                // ì§„í–‰ ë°” ì• ë‹ˆë©”ì´ì…˜ (2ì´ˆ)
                animateProgress(100, 2000);
            } else if (stageNumber === 2) {
                document.getElementById('resultStage').classList.add('active');
                updateProgress(0, 'ê²°ê³¼ í‘œì‹œ ì¤‘...');

                // ì§„í–‰ ë°” ì• ë‹ˆë©”ì´ì…˜ (4ì´ˆ)
                animateProgress(100, 4000);
            }
        }

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }

        function animateProgress(targetPercentage, duration) {
            const startTime = Date.now();
            const startPercentage = 0;

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentPercentage = startPercentage + (targetPercentage - startPercentage) * progress;

                updateProgress(currentPercentage, document.getElementById('progressText').textContent);

                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }

            animate();
        }

        function goBack() {
            // íŒì—…ì—ì„œ í˜¸ì¶œëœ ê²½ìš° ë¶€ëª¨ ìœˆë„ìš°ì—ê²Œ ë‹«ê¸° ë©”ì‹œì§€ ì „ì†¡
            if (window.parent !== window) {
                window.parent.postMessage('closePopup', '*');
            } else {
                window.location.href = '../ê¸°ë³¸ê²Œì„í™”ë©´/index.html';
            }
        }

        // ìë™ìœ¼ë¡œ 4ì´ˆ í›„ ë‹«ê¸°
        function autoClose() {
            setTimeout(() => {
                goBack();
            }, 4000);
        }
    </script>
</body>

</html>